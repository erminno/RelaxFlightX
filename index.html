<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RelaxFlightX - Flight Simulator Pro v5.7</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-bg: rgba(15, 23, 42, 0.95);
            --primary: #38bdf8;
            --accent: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --sidebar-width: 380px;
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: block; 
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: relative;
        }

        /* --- MAIN MENU --- */
        #main-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 80%);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 1.5s ease-in-out, visibility 1.5s;
        }
        #main-menu.visible { opacity: 1; }
        #main-menu.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .menu-content { text-align: center; color: white; animation: float 6s ease-in-out infinite; padding: 2rem; width: 100%; max-width: 600px; }
        .menu-icon { font-size: 5rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 0 30px rgba(56,189,248,0.6)); }
        .menu-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -2px; margin-bottom: 10px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .menu-subtitle { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 1rem; margin-bottom: 50px; letter-spacing: 1px; }
        
        .menu-btn {
            background: var(--primary); color: #0f172a; border: none; padding: 18px 45px;
            font-size: 1.2rem; font-weight: 700; border-radius: 50px; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 25px rgba(56,189,248,0.4);
            display: inline-flex; align-items: center; gap: 12px; text-transform: uppercase; letter-spacing: 1px;
        }
        .menu-btn:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 0 50px rgba(56,189,248,0.7); background: #fff; }
        
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* --- GAME UI --- */
        .game-ui { opacity: 0; transition: opacity 1.5s ease-in-out; pointer-events: none; }
        .game-ui.visible { opacity: 1; pointer-events: auto; }

        #day-night-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 30%, rgba(2, 6, 23, 0.95) 100%);
            opacity: 0; pointer-events: none; z-index: 50; transition: opacity 2s ease-in-out; mix-blend-mode: multiply;
        }

        #map { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; background: #0f172a; }
        .leaflet-container { background: #0f172a !important; }

        /* --- ETA PANEL --- */
        .eta-panel {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.75); padding: 10px 24px;
            border-radius: 50px; border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(12px); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            color: white; font-family: 'JetBrains Mono', monospace; font-weight: 700;
            font-size: 1rem; z-index: 1100; display: none; align-items: center; gap: 10px; white-space: nowrap;
        }

        /* --- CONTROLLI CENTRALI --- */
        .center-controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 12px; z-index: 1100; transition: bottom 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .control-pill-btn {
            background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-muted); padding: 8px 20px; border-radius: 50px; cursor: pointer;
            backdrop-filter: blur(12px); font-family: 'Inter', sans-serif; font-size: 0.9rem;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .control-pill-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); color: white; }
        .control-pill-btn.active { background: var(--primary); color: #0f172a; border-color: var(--primary); box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        .control-pill-btn.paused { background: var(--warning); color: #0f172a; border-color: var(--warning); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); animation: pulse-pause 2s infinite; }

        @keyframes pulse-pause { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- TOP RIGHT PANEL --- */
        .top-panel-container {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            display: flex; flex-direction: column; align-items: flex-end; gap: 12px; width: 350px;
        }

        .speed-controls {
            background: rgba(15, 23, 42, 0.75); padding: 8px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.1); display: flex; gap: 5px;
            backdrop-filter: blur(12px); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 100%; justify-content: space-around;
        }

        .speed-btn {
            background: transparent; border: none; color: var(--text-muted);
            padding: 8px 16px; border-radius: 40px; cursor: pointer; font-weight: 700;
            font-size: 0.85rem; transition: all 0.3s ease; flex-grow: 1; text-align: center;
        }
        .speed-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .speed-btn.active { background: var(--primary); color: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }

        .env-info-panel, .info-panel-top {
            background: rgba(15, 23, 42, 0.75); padding: 12px 20px;
            border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(12px); box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 100%;
        }

        .env-info-panel { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .env-item { text-align: right; }
        .env-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .env-value { font-size: 1rem; font-weight: 700; color: white; display: flex; align-items: center; justify-content: flex-end; gap: 8px; }

        .telemetry-dropdown-panel {
            background: rgba(15, 23, 42, 0.9); border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(16px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .telemetry-dropdown-panel:hover { border-color: rgba(56, 189, 248, 0.4); }
        
        .telemetry-toggle {
            padding: 18px 24px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; background: linear-gradient(to right, rgba(255,255,255,0.03), transparent);
            transition: background 0.3s ease;
        }
        .telemetry-toggle:hover { background: linear-gradient(to right, rgba(255,255,255,0.08), transparent); }
        
        .telemetry-toggle h3 { 
            font-size: 0.95rem; font-weight: 700; color: white; margin: 0; 
            display: flex; align-items: center; gap: 12px; letter-spacing: 0.5px; text-transform: uppercase;
        }
        .telemetry-toggle .chevron { 
            color: var(--text-muted); font-size: 0.9rem; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), color 0.3s;
        }
        .telemetry-dropdown-panel.open .chevron { transform: rotate(180deg); color: var(--primary); }

        .telemetry-dropdown-content {
            display: grid; grid-template-rows: 0fr; opacity: 0;
            transition: grid-template-rows 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            background: rgba(0,0,0,0.2); padding: 0 24px;
        }
        .telemetry-dropdown-panel.open .telemetry-dropdown-content { grid-template-rows: 1fr; opacity: 1; padding-bottom: 24px; }
        
        .telemetry-dropdown-grid { 
            overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            transform: translateY(-15px); transition: transform 0.5s ease; padding-top: 15px;
        }
        .telemetry-dropdown-panel.open .telemetry-dropdown-grid { transform: translateY(0); }
        
        .telemetry-item-dropdown { 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.8)); 
            padding: 1.2rem 1rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; gap: 5px; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .telemetry-item-dropdown::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--primary); opacity: 0.5; transition: opacity 0.3s;
        }
        .telemetry-item-dropdown:hover {
            transform: translateY(-2px); background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.95)); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); border-color: rgba(56, 189, 248, 0.2);
        }
        .telemetry-item-dropdown:hover::before { opacity: 1; box-shadow: 0 0 10px var(--primary); }
        
        .telemetry-item-dropdown .t-label {
            font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
        }
        .telemetry-item-dropdown .t-value {
            font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; color: white; font-weight: 700;
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.1); display: flex; align-items: baseline; gap: 4px;
        }
        .telemetry-item-dropdown .t-value span.unit { font-size: 0.75rem; color: var(--text-muted); font-weight: 400; }

        .info-panel-top .t-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .info-panel-top .t-value { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--accent); font-weight: 700; }

        .follow-btn {
            background: rgba(15, 23, 42, 0.75); border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 100%; padding: 12px 20px;
            font-size: 0.9rem; font-weight: 700; color: var(--text-muted); cursor: pointer;
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: -2px;
        }
        .follow-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .follow-btn.active { background: var(--primary); color: #0f172a; box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }
        
        /* --- SIDEBAR --- */
        .sidebar {
            position: absolute; top: 20px; left: 20px; width: var(--sidebar-width); height: auto;
            max-height: calc(100vh - 40px); background: var(--panel-bg); border-radius: var(--radius-lg);
            border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column;
            z-index: 2000; box-shadow: 0 10px 40px rgba(0,0,0,0.5); backdrop-filter: blur(16px);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); overflow: hidden;
        }

        /* Maniglia per sidebar mobile */
        .sidebar-handle-container {
            width: 100%; display: none; justify-content: center; padding: 12px 0 0 0;
            cursor: pointer; background: transparent; touch-action: none;
        }
        .sidebar-handle {
            width: 50px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 10px;
        }

        .header {
            padding: 1.5rem; background: linear-gradient(to right, rgba(255, 255, 255, 0.03), transparent);
            border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px;
        }
        .brand { font-size: 1.4rem; font-weight: 700; letter-spacing: -0.5px; color: var(--primary); text-transform: uppercase; }
        .content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 1rem; }

        .control-group { margin-bottom: 0.5rem; position: relative; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px; }

        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: '\f078'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--primary); pointer-events: none;
        }

        select {
            width: 100%; padding: 1rem; background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); font-size: 0.95rem; color: white;
            appearance: none; cursor: pointer; transition: all 0.3s ease;
        }
        select:hover { background: rgba(30, 41, 59, 0.9); }
        select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1); }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 0.5rem; }

        .btn {
            width: 100%; padding: 1.1rem; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 700;
            cursor: pointer; border: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-primary { background: var(--primary); color: #0f172a; box-shadow: 0 4px 20px rgba(56, 189, 248, 0.3); }
        .btn-primary:hover { background: #7dd3fc; transform: translateY(-2px) scale(1.02); }
        .btn-primary:disabled { background: #334155; color: #64748b; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5); color: var(--danger); margin-top: 10px; display: none; 
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.2); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2); transform: translateY(-2px); }

        .random-row-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .random-btn { background: transparent; border: none; color: var(--primary); cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; padding: 4px; }
        .random-btn:hover { color: white; transform: rotate(180deg); filter: drop-shadow(0 0 5px var(--primary)); }

        .settings-panel {
            position: absolute; bottom: 20px; left: 20px; z-index: 2500;
            display: flex; flex-direction: column; gap: 8px; align-items: flex-start;
        }
        .lang-btn {
            background: rgba(15, 23, 42, 0.85); color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; backdrop-filter: blur(12px);
            display: flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .lang-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
        .credits {
            font-size: 0.7rem; color: rgba(255,255,255,0.6); font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;
        }

        .news-btn-wrapper { position: absolute; bottom: 25px; right: 70px; z-index: 1000; }
        .news-btn {
            background: rgba(15, 23, 42, 0.85); color: var(--primary); border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; backdrop-filter: blur(12px);
            display: flex; align-items: center; gap: 8px; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: 'Inter', sans-serif; font-size: 0.9rem;
        }
        .news-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); color: white; }

        /* --- UPDATED NEWS GUI --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            z-index: 3000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }

        .modal-content {
            background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(56, 189, 248, 0.3); border-radius: 24px;
            padding: 2.5rem; width: 90%; max-width: 450px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.7), 0 0 30px rgba(56,189,248,0.1); position: relative; 
            transform: translateY(30px) scale(0.95); transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            text-align: left; overflow: hidden;
        }
        .modal-content::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }
        .modal-overlay.open .modal-content { transform: translateY(0) scale(1); }

        .close-modal {
            position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none;
            color: var(--text-muted); font-size: 1.2rem; cursor: pointer; transition: all 0.2s;
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .close-modal:hover { color: white; background: rgba(239, 68, 68, 0.5); }
        
        .modal-title {
            font-size: 1.5rem; font-weight: 800; color: white; margin-bottom: 2rem;
            display: flex; align-items: center; gap: 12px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-title i { color: var(--primary); filter: drop-shadow(0 0 10px rgba(56,189,248,0.5)); }
        
        .news-list { list-style: none; margin: 0; padding: 0; text-align: left; }
        .news-list li {
            margin-bottom: 1rem; display: flex; align-items: center; gap: 16px;
            color: var(--text-main); font-size: 1.05rem; background: linear-gradient(to right, rgba(255,255,255,0.03), transparent);
            padding: 16px; border-radius: 16px; border-left: 4px solid var(--primary); transition: all 0.3s ease;
        }
        .news-list li:hover {
            transform: translateX(5px); background: linear-gradient(to right, rgba(255,255,255,0.08), transparent);
            border-left-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .news-list li i { color: var(--text-muted); font-size: 1.1rem; }
        .news-list li:hover i { color: white; }

        /* --- MOBILE ADJUSTMENTS (ORDINE E PULIZIA) --- */
        @media (max-width: 768px) {
            /* 1. Sidebar come Bottom Sheet (Fissa in basso, comprimibile) */
            .sidebar { 
                top: auto; bottom: 0; left: 0; transform: none; width: 100%; 
                max-height: 50vh; /* Leggermente più alta per ospitare tutto */
                border-radius: 24px 24px 0 0; border-bottom: none; border-left: none; border-right: none;
                padding-bottom: 20px; transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            /* Stato "abbassato" della sidebar (solo header visibile) */
            .sidebar.minimized {
                transform: translateY(calc(100% - 60px)); /* Lascia 60px visibili per riaprirlo */
            }

            .sidebar-handle-container { display: flex; } /* Mostra la maniglia solo su mobile */
            
            .sidebar .header { padding: 0.8rem 1rem; border-bottom: none; }
            .sidebar .content { padding: 0 1rem 1rem 1rem; gap: 0.6rem; }
            .sidebar .btn { padding: 0.8rem; font-size: 0.9rem; }
            .control-group label { margin-bottom: 0.2rem; }
            select { padding: 0.7rem; }

            /* 2. Top Right Panel: MOLTO PIÙ PICCOLO SU MOBILE */
            .top-panel-container { 
                top: 50px; right: 8px; width: auto; max-width: 170px; /* Ridotto drasticamente */
                align-items: flex-end; gap: 6px;
            }
            
            .telemetry-dropdown-panel { width: 100%; border-radius: 12px; }
            .telemetry-toggle { padding: 8px 10px; }
            .telemetry-toggle h3 { font-size: 0.7rem; }
            .telemetry-toggle .chevron { font-size: 0.7rem; }
            
            .telemetry-dropdown-content { padding: 0 10px; }
            .telemetry-dropdown-panel.open .telemetry-dropdown-content { padding-bottom: 10px; }
            .telemetry-dropdown-grid { gap: 6px; padding-top: 8px; }
            
            .telemetry-item-dropdown { padding: 0.6rem 0.5rem; border-radius: 10px; }
            .telemetry-item-dropdown .t-label { font-size: 0.55rem; margin-bottom: 2px; }
            .telemetry-item-dropdown .t-value { font-size: 0.9rem; }
            .telemetry-item-dropdown .t-value span.unit { font-size: 0.55rem; }

            .env-info-panel, .info-panel-top { padding: 8px 10px; border-radius: 12px; }
            .env-label, .info-panel-top .t-label { font-size: 0.55rem; }
            .env-value, .info-panel-top .t-value { font-size: 0.8rem; }
            
            .speed-controls { padding: 3px; border-radius: 30px; }
            .speed-btn { padding: 4px 8px; font-size: 0.65rem; }

            .follow-btn { padding: 8px 12px; font-size: 0.75rem; border-radius: 12px; }

            /* 3. ETA Panel */
            .eta-panel { top: 10px; padding: 4px 12px; font-size: 0.8rem; border-radius: 30px; }
            
            /* 4. Settings/Lang */
            .settings-panel { top: 10px; left: 10px; bottom: auto; }
            .lang-btn { padding: 4px 10px; font-size: 0.75rem; }
            .credits { display: none; }
            
            /* 5. Controlli Volo: Si muovono con la sidebar */
            .center-controls { 
                bottom: 52vh; width: auto; gap: 10px; /* Posizione iniziale */
            }
            .center-controls.minimized {
                bottom: 90px; /* Scende quando la sidebar scende */
            }
            
            .control-pill-btn { padding: 8px 16px; font-size: 0.8rem; background: rgba(15, 23, 42, 0.95); }

            /* 6. News Button */
            .news-btn-wrapper { top: 50px; left: 10px; right: auto; bottom: auto; }
            .news-btn { padding: 4px 10px; font-size: 0.75rem; }
            
            .menu-title { font-size: 2.2rem; }
            .menu-icon { font-size: 3rem; margin-bottom: 10px; }
            .menu-subtitle { font-size: 0.9rem; margin-bottom: 30px; }
        }
    </style>
</head>
<body>
    
    <!-- MENU PRINCIPALE -->
    <div id="main-menu">
        <div class="menu-content">
            <i class="fa-solid fa-plane-up menu-icon"></i>
            <h1 class="menu-title">RelaxFlightX</h1>
            <p class="menu-subtitle">The Most Realistic Flight Simulation</p>
            <button class="menu-btn" onclick="enterGame()">
                <i class="fa-solid fa-play"></i> Inizia il Volo
            </button>
        </div>
    </div>

    <div id="day-night-overlay"></div>

    <div class="news-btn-wrapper game-ui">
        <button class="news-btn" onclick="toggleNewsModal()">
            <i class="fa-solid fa-newspaper"></i> News
        </button>
    </div>

    <div id="news-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-modal" onclick="toggleNewsModal()">&times;</button>
            <div class="modal-title">
                <i class="fa-solid fa-bullhorn"></i> <span data-translate="news_title">Novità v5.5</span>
            </div>
            <ul class="news-list">
                <li><i class="fa-solid fa-plane-circle-check"></i> <div><b data-translate="news_airlines">Compagnie Aeree</b><br><span style="font-size:0.85rem; color:#94a3b8" data-translate="news_liveries">Nuove livree</span></div></li>
                <li><i class="fa-solid fa-compass-drafting"></i> <div><b data-translate="news_rotation">Fix Rotazione</b><br><span style="font-size:0.85rem; color:#94a3b8" data-translate="news_fixes">Bug Fixes</span></div></li>
                <li><i class="fa-solid fa-earth-americas"></i> <div><b data-translate="news_world">Mondo Espanso</b><br><span style="font-size:0.85rem; color:#94a3b8" data-translate="news_expansion">+100 Aeroporti internazionali</span></div></li>
            </ul>
        </div>
    </div>

    <div class="settings-panel game-ui">
        <button class="lang-btn" onclick="toggleLanguage()">
            <i class="fa-solid fa-globe"></i> <span id="lang-text">IT</span>
        </button>
        <div class="credits">Game designed by Minno</div>
    </div>

    <div id="eta-display" class="eta-panel game-ui">
        <i class="fa-regular fa-clock"></i> 
        <span id="eta-text">--:--</span>
    </div>

    <div id="center-controls" class="center-controls game-ui" style="display:none;">
        <button class="control-pill-btn" id="pause-btn" onclick="togglePause()">
            <i class="fa-solid fa-pause"></i> <span data-translate="pause">Pausa</span>
        </button>
        <button class="control-pill-btn" id="map-btn" onclick="toggleMapType()">
            <i class="fa-solid fa-map"></i> <span data-translate="map_view">Mappa</span>
        </button>
    </div>

    <div class="top-panel-container game-ui">
        <div class="speed-controls">
            <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
            <button class="speed-btn" onclick="setSpeed(5)">5x</button>
            <button class="speed-btn" onclick="setSpeed(10)">10x</button>
            <button class="speed-btn" onclick="setSpeed(50)" style="color:var(--danger)">50x</button>
        </div>

        <div class="env-info-panel" id="env-panel">
            <div class="env-item">
                <div class="env-label" data-translate="local_time">Ora Locale</div>
                <div class="env-value" id="top-local-time">--:--</div>
            </div>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2);"></div>
            <div class="env-item">
                <div class="env-label" data-translate="weather_dest">Meteo</div>
                <div class="env-value" id="top-weather-dest">-- <i class="fa-solid fa-cloud"></i></div>
            </div>
        </div>

        <div class="telemetry-dropdown-panel" id="telemetry-dropdown">
            <div class="telemetry-toggle" onclick="toggleTelemetry()">
                <h3><i class="fa-solid fa-gauge-high" style="color:var(--primary)"></i> <span data-translate="flight_data">Dati Volo</span></h3>
                <i class="fa-solid fa-chevron-down chevron"></i>
            </div>
            <div class="telemetry-dropdown-content">
                <div class="telemetry-dropdown-grid">
                    <div class="telemetry-item-dropdown">
                        <div class="t-label"><span data-translate="altitude">Altitudine</span> <i class="fa-solid fa-cloud-arrow-up"></i></div>
                        <div class="t-value"><span id="alt-val-top">0</span> <span class="unit">ft</span></div>
                    </div>
                    <div class="telemetry-item-dropdown">
                        <div class="t-label"><span data-translate="speed">Velocità</span> <i class="fa-solid fa-gauge-high"></i></div>
                        <div class="t-value"><span id="spd-val-top">0</span> <span class="unit">kts</span></div>
                    </div>
                    <div class="telemetry-item-dropdown">
                        <div class="t-label"><span data-translate="distance">Distanza</span> <i class="fa-solid fa-ruler"></i></div>
                        <div class="t-value small" id="dist-val-top-container"><span id="dist-val-top">0</span> <span class="unit">NM</span></div>
                    </div>
                    <div class="telemetry-item-dropdown">
                        <div class="t-label"><span data-translate="fuel">Carburante</span> <i class="fa-solid fa-gas-pump"></i></div>
                        <div class="t-value small" id="fuel-val-top-container"><span id="fuel-val-top">100</span> <span class="unit">%</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-panel-top" id="telemetry-cabin" style="display:none; transition: all 0.5s;">
            <div class="t-label" data-translate="cabin_info">Info Cabina</div>
            <div class="t-value" id="status-val" style="color:var(--accent); white-space: normal;">Al Gate</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:6px;">
                <div style="font-size: 0.75rem; color: #94a3b8;" id="flight-no">Volo: --</div>
                <div style="font-size: 0.75rem; color: #f8fafc; font-weight:700;" id="pax-count"><i class="fa-solid fa-users" style="color:var(--primary)"></i> <span>--</span></div>
            </div>
        </div>

        <button class="follow-btn" id="follow-btn" onclick="toggleFollowPlane()">
            <i class="fa-solid fa-eye"></i> <span id="follow-text" data-translate="follow_plane">Segui Aereo</span>
        </button>
    </div>

    <div class="sidebar game-ui" id="control-sidebar">
        <!-- Maniglia per lo swipe su mobile -->
        <div class="sidebar-handle-container" id="sidebar-handle">
            <div class="sidebar-handle"></div>
        </div>

        <div class="header">
            <i class="fa-solid fa-plane-up" style="color:var(--primary); font-size: 1.5rem; filter: drop-shadow(0 0 5px rgba(56,189,248,0.5));"></i>
            <div class="brand">RelaxFlightX <span style="font-size:0.8rem; color:var(--text-muted); vertical-align:middle; font-weight:400;">SIMULATOR</span></div>
        </div>

        <div class="content">
            <div class="control-group">
                <label data-translate="airline">Compagnia Aerea</label>
                <div class="select-wrapper">
                    <select id="airline-select">
                        <option value="RYR">Ryanair (FR)</option>
                        <option value="EZY">EasyJet (U2)</option>
                        <option value="ITY">ITA Airways (AZ)</option>
                        <option value="DLH">Lufthansa (LH)</option>
                        <option value="AFR">Air France (AF)</option>
                        <option value="BAW">British Airways (BA)</option>
                        <option value="UAE">Emirates (EK)</option>
                        <option value="AAL">American Airlines (AA)</option>
                        <option value="DAL">Delta Air Lines (DL)</option>
                        <option value="WZZ">Wizz Air (W6)</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <label data-translate="aircraft">Aeromobile</label>
                <div class="select-wrapper">
                    <select id="aircraft-type">
                        <option value="A320">Airbus A320 (Medio Raggio)</option>
                        <option value="B787">Boeing 787 Dreamliner (Lungo Raggio)</option>
                        <option value="C172">Cessna 172 (Turistico - Lento)</option>
                        <option value="CONC">Concorde (Supersonico)</option>
                        <option value="B747">Boeing 747-8 "Queen of Skies"</option>
                        <option value="A380">Airbus A380 "Superjumbo"</option>
                        <option value="B737">Boeing 737 (Corto Raggio)</option>
                        <option value="A350">Airbus A350 XWB</option>
                        <option value="E190">Embraer E190 (Regionale)</option>
                        <option value="G7500">Bombardier Global 7500 (Privato)</option>
                        <option value="F22">F-22 Raptor (Caccia Militare)</option>
                        <option value="AN225">Antonov An-225 "Mriya" (Cargo)</option>
                        <option value="SPIT">Supermarine Spitfire (Storico)</option>
                        <option value="PC12">Pilatus PC-12 (Turboelica)</option>
                    </select>
                </div>
            </div>

            <div class="random-row-header">
                <label style="margin:0" data-translate="route_plan">Piano di Volo</label>
                <button class="random-btn" onclick="randomizeRoute()" title="Rotta Casuale">
                    <i class="fa-solid fa-dice"></i> Random
                </button>
            </div>

            <div class="info-grid">
                <div class="control-group" style="margin:0">
                    <label data-translate="origin" style="font-size:0.65rem">Origine</label>
                    <div class="select-wrapper"><select id="departure"></select></div>
                </div>
                <div class="control-group" style="margin:0">
                    <label data-translate="destination" style="font-size:0.65rem">Destinazione</label>
                    <div class="select-wrapper"><select id="arrival"></select></div>
                </div>
            </div>

            <button class="btn btn-primary" id="fly-btn" onclick="startFlight()">
                <i class="fa-solid fa-paper-plane"></i> <span id="fly-btn-text" data-translate="takeoff">Decolla</span>
            </button>

            <button class="btn btn-danger" id="cancel-btn" onclick="cancelFlight()">
                <i class="fa-solid fa-ban"></i> <span id="cancel-btn-text" data-translate="cancel_flight">Annulla Volo</span>
            </button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- TRANSLATION SYSTEM ---
        let currentLang = 'it';
        const translations = {
            it: {
                local_time: "Ora Locale", weather_dest: "Meteo", flight_data: "Dati Volo",
                altitude: "Altitudine", speed: "Velocità", distance: "Distanza", fuel: "Carburante",
                follow_plane: "Segui Aereo", stop_follow: "Smetti di Seguire", aircraft: "Aeromobile", airline: "Compagnia Aerea",
                route_plan: "Piano di Volo", origin: "Origine", destination: "Destinazione", takeoff: "Decolla",
                cancel_flight: "Annulla Volo", completed: "Completato", cabin_info: "Info Cabina",
                status_gate: "Al Gate", status_takeoff: "DECOLLO", status_landing: "ATTERRAGGIO", status_cruise: "CROCIERA",
                status_meal: "SERVIZIO PASTI", status_systems: "CONTROLLO SISTEMI", status_cancelled: "ANNULLATO", status_arrived: "ARRIVATO",
                eta_prefix: "Arrivo in: ", eta_landing_soon: "In atterraggio...", eta_landing_now: "Atterraggio in corso...",
                ac_a320: "Airbus A320 (Medio Raggio)", ac_b787: "Boeing 787 Dreamliner (Lungo Raggio)", ac_c172: "Cessna 172 (Turistico - Lento)",
                ac_conc: "Concorde (Supersonico)", ac_b747: "Boeing 747-8 \"Queen of Skies\"", ac_a380: "Airbus A380 \"Superjumbo\"",
                ac_b737: "Boeing 737 (Corto Raggio)", ac_a350: "Airbus A350 XWB", ac_e190: "Embraer E190 (Regionale)",
                ac_g7500: "Bombardier Global 7500 (Privato)", ac_f22: "F-22 Raptor (Caccia Militare)", ac_an225: "Antonov An-225 \"Mriya\" (Cargo)",
                ac_spit: "Supermarine Spitfire (Storico)", ac_pc12: "Pilatus PC-12 (Turboelica)",
                pause: "Pausa", resume: "Riprendi", map_view: "Mappa", sat_view: "Satellite",
                news_title: "Novità v5.6", news_airlines: "Compagnie Aeree", news_liveries: "Nuove livree",
                news_rotation: "Fix Rotazione", news_fixes: "Bug Fixes", news_world: "Mondo Espanso", news_expansion: "+130 Aeroporti internazionali"
            },
            en: {
                local_time: "Local Time", weather_dest: "Weather", flight_data: "Flight Data",
                altitude: "Altitude", speed: "Speed", distance: "Distance", fuel: "Fuel",
                follow_plane: "Follow Plane", stop_follow: "Stop Following", aircraft: "Aircraft", airline: "Airline",
                route_plan: "Flight Plan", origin: "Origin", destination: "Destination", takeoff: "Take Off",
                cancel_flight: "Cancel Flight", completed: "Completed", cabin_info: "Cabin Info",
                status_gate: "At Gate", status_takeoff: "TAKEOFF", status_landing: "LANDING", status_cruise: "CRUISE",
                status_meal: "MEAL SERVICE", status_systems: "SYSTEMS CHECK", status_cancelled: "CANCELLED", status_arrived: "ARRIVED",
                eta_prefix: "Arriving in: ", eta_landing_soon: "Landing...", eta_landing_now: "Landing in progress...",
                ac_a320: "Airbus A320 (Medium Range)", ac_b787: "Boeing 787 Dreamliner (Long Range)", ac_c172: "Cessna 172 (Tourist - Slow)",
                ac_conc: "Concorde (Supersonic)", ac_b747: "Boeing 747-8 \"Queen of Skies\"", ac_a380: "Airbus A380 \"Superjumbo\"",
                ac_b737: "Boeing 737 (Short Range)", ac_a350: "Airbus A350 XWB", ac_e190: "Embraer E190 (Regional)",
                ac_g7500: "Bombardier Global 7500 (Private)", ac_f22: "F-22 Raptor (Fighter Jet)", ac_an225: "Antonov An-225 \"Mriya\" (Cargo)",
                ac_spit: "Supermarine Spitfire (Historic)", ac_pc12: "Pilatus PC-12 (Turboprop)",
                pause: "Pause", resume: "Resume", map_view: "Map", sat_view: "Satellite",
                news_title: "News v5.6", news_airlines: "New Airlines", news_liveries: "New liveries",
                news_rotation: "Rotation Fix", news_fixes: "Bug Fixes", news_world: "World Expanded", news_expansion: "+130 International Airports"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'it' ? 'en' : 'it';
            document.getElementById('lang-text').innerText = currentLang.toUpperCase();
            updateInterfaceText();
        }

        function updateInterfaceText() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key]) el.innerText = t[key];
            });
            const acSelect = document.getElementById('aircraft-type');
            acSelect.options[0].text = t.ac_a320; acSelect.options[1].text = t.ac_b787;
            acSelect.options[2].text = t.ac_c172; acSelect.options[3].text = t.ac_conc;
            acSelect.options[4].text = t.ac_b747; acSelect.options[5].text = t.ac_a380;
            acSelect.options[6].text = t.ac_b737; acSelect.options[7].text = t.ac_a350;
            acSelect.options[8].text = t.ac_e190; acSelect.options[9].text = t.ac_g7500;
            acSelect.options[10].text = t.ac_f22; acSelect.options[11].text = t.ac_an225;
            acSelect.options[12].text = t.ac_spit; acSelect.options[13].text = t.ac_pc12;

            if(!flightInterval) {
                 document.getElementById('fly-btn-text').innerText = t.takeoff;
                 document.getElementById('status-val').innerText = t.status_gate;
            } else {
                 document.getElementById('cancel-btn-text').innerText = t.cancel_flight;
            }
            const followBtn = document.getElementById('follow-btn');
            const isFollowing = followBtn.classList.contains('active');
            document.getElementById('follow-text').innerText = isFollowing ? t.stop_follow : t.follow_plane;
            
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.querySelector('span').innerText = isPaused ? t.resume : t.pause;
            
            const mapBtn = document.getElementById('map-btn');
            mapBtn.querySelector('span').innerText = currentMapMode === 'sat' ? t.map_view : t.sat_view;
        }

        window.onload = function() {
            setTimeout(() => { document.getElementById('main-menu').classList.add('visible'); }, 100);
            
            // --- MOBILE SIDEBAR SWIPE LOGIC ---
            const sidebar = document.getElementById('control-sidebar');
            const handle = document.getElementById('sidebar-handle');
            const centerControls = document.getElementById('center-controls');
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            handle.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
            }, {passive: true});

            handle.addEventListener('touchmove', (e) => {
                if(!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;
                // Simple visual feedback could go here if needed
            }, {passive: true});

            handle.addEventListener('touchend', (e) => {
                if(!isDragging) return;
                isDragging = false;
                const diff = currentY - startY;
                
                // If swipe down > 30px, minimize
                if (diff > 30) {
                    sidebar.classList.add('minimized');
                    centerControls.classList.add('minimized');
                }
                // If swipe up < -30px (dragged up), maximize
                else if (diff < -30) {
                    sidebar.classList.remove('minimized');
                    centerControls.classList.remove('minimized');
                }
                // Also toggle on click (small movement)
                else if (Math.abs(diff) < 5) {
                    sidebar.classList.toggle('minimized');
                    centerControls.classList.toggle('minimized');
                }
            });
            
            // Allow clicking header too to toggle
            document.querySelector('.sidebar .header').addEventListener('click', () => {
                if(window.innerWidth <= 768) {
                    sidebar.classList.toggle('minimized');
                    centerControls.classList.toggle('minimized');
                }
            });
        };
        function enterGame() {
            const menu = document.getElementById('main-menu');
            const uiElements = document.querySelectorAll('.game-ui');
            menu.classList.add('hidden');
            setTimeout(() => { uiElements.forEach(el => el.classList.add('visible')); }, 500);
        }
        function toggleNewsModal() { document.getElementById('news-modal').classList.toggle('open'); }

        const airports = [
            // ORIGINALI
            { id: 'FCO', name: 'Roma Fiumicino', lat: 41.8003, lon: 12.2462 }, { id: 'CIA', name: 'Roma Ciampino', lat: 41.7994, lon: 12.5926 },
            { id: 'MXP', name: 'Milano Malpensa', lat: 45.6289, lon: 8.7251 }, { id: 'LIN', name: 'Milano Linate', lat: 45.4613, lon: 9.2795 },
            { id: 'BGY', name: 'Milano Bergamo', lat: 45.6701, lon: 9.7042 }, { id: 'VCE', name: 'Venezia Marco Polo', lat: 45.5053, lon: 12.3519 },
            { id: 'NAP', name: 'Napoli Capodichino', lat: 40.8844, lon: 14.2908 }, { id: 'CTA', name: 'Catania Fontanarossa', lat: 37.4668, lon: 15.0664 },
            { id: 'PMO', name: 'Palermo Punta Raisi', lat: 38.1760, lon: 13.0911 }, { id: 'BLQ', name: 'Bologna Guglielmo Marconi', lat: 44.5354, lon: 11.2887 },
            { id: 'TRN', name: 'Torino Caselle', lat: 45.2008, lon: 7.6496 }, { id: 'CAG', name: 'Cagliari Elmas', lat: 39.2515, lon: 9.0543 },
            { id: 'BRI', name: 'Bari Karol Wojtyła', lat: 41.1389, lon: 16.7606 }, { id: 'VRN', name: 'Verona Villafranca', lat: 45.3957, lon: 10.8885 },
            { id: 'LHR', name: 'Londra Heathrow', lat: 51.4700, lon: -0.4543 }, { id: 'LGW', name: 'Londra Gatwick', lat: 51.1537, lon: -0.1821 },
            { id: 'CDG', name: 'Parigi CDG', lat: 49.0097, lon: 2.5479 }, { id: 'ORY', name: 'Parigi Orly', lat: 48.7233, lon: 2.3794 },
            { id: 'FRA', name: 'Francoforte', lat: 50.0379, lon: 8.5622 }, { id: 'MUC', name: 'Monaco', lat: 48.3537, lon: 11.7750 },
            { id: 'BER', name: 'Berlino Brandeburgo', lat: 52.3667, lon: 13.5033 }, { id: 'AMS', name: 'Amsterdam', lat: 52.3086, lon: 4.7639 },
            { id: 'MAD', name: 'Madrid', lat: 40.4839, lon: -3.5679 }, { id: 'BCN', name: 'Barcellona El Prat', lat: 41.2974, lon: 2.0833 },
            { id: 'ZRH', name: 'Zurigo', lat: 47.4582, lon: 8.5555 }, { id: 'GVA', name: 'Ginevra', lat: 46.2370, lon: 6.1092 },
            { id: 'VIE', name: 'Vienna', lat: 48.1103, lon: 16.5697 }, { id: 'BRU', name: 'Bruxelles', lat: 50.9014, lon: 4.4844 },
            { id: 'ATH', name: 'Atene', lat: 37.9364, lon: 23.9445 }, { id: 'IST', name: 'Istanbul', lat: 41.2753, lon: 28.7519 },
            { id: 'DUB', name: 'Dublino', lat: 53.4264, lon: -6.2499 }, { id: 'LIS', name: 'Lisbona', lat: 38.7742, lon: -9.1342 },
            { id: 'OSL', name: 'Oslo', lat: 60.1976, lon: 11.1004 }, { id: 'ARN', name: 'Stoccolma', lat: 59.6498, lon: 17.9238 },
            { id: 'CPH', name: 'Copenhagen', lat: 55.6180, lon: 12.6508 }, { id: 'HEL', name: 'Helsinki', lat: 60.3172, lon: 24.9633 },
            { id: 'WAW', name: 'Varsavia', lat: 52.1672, lon: 20.9679 }, { id: 'KEF', name: 'Reykjavik', lat: 63.9850, lon: -22.6056 },
            { id: 'SVO', name: 'Mosca Sheremetyevo', lat: 55.9726, lon: 37.4146 }, { id: 'PRG', name: 'Praga', lat: 50.1008, lon: 14.2600 },
            { id: 'BUD', name: 'Budapest', lat: 47.4369, lon: 19.2556 }, { id: 'NCE', name: 'Nizza', lat: 43.6617, lon: 7.2167 },
            { id: 'MLA', name: 'Malta', lat: 35.8575, lon: 14.4775 }, { id: 'EDI', name: 'Edimburgo', lat: 55.9508, lon: -3.3615 },
            { id: 'JFK', name: 'New York JFK', lat: 40.6413, lon: -73.7781 }, { id: 'EWR', name: 'Newark Liberty', lat: 40.6895, lon: -74.1745 },
            { id: 'LAX', name: 'Los Angeles', lat: 33.9416, lon: -118.4085 }, { id: 'SFO', name: 'San Francisco', lat: 37.6213, lon: -122.3790 },
            { id: 'ORD', name: 'Chicago O\'Hare', lat: 41.9742, lon: -87.9073 }, { id: 'ATL', name: 'Atlanta Hartsfield-Jackson', lat: 33.6407, lon: -84.4277 },
            { id: 'DFW', name: 'Dallas/Fort Worth', lat: 32.8998, lon: -97.0403 }, { id: 'DEN', name: 'Denver', lat: 39.8561, lon: -104.6737 },
            { id: 'MIA', name: 'Miami', lat: 25.7959, lon: -80.2870 }, { id: 'MCO', name: 'Orlando', lat: 28.4312, lon: -81.3081 },
            { id: 'SEA', name: 'Seattle Tacoma', lat: 47.4502, lon: -122.3116 }, { id: 'BOS', name: 'Boston Logan', lat: 42.3656, lon: -71.0096 },
            { id: 'LAS', name: 'Las Vegas', lat: 36.0840, lon: -115.1537 }, { id: 'YYZ', name: 'Toronto Pearson', lat: 43.6777, lon: -79.6248 },
            { id: 'YVR', name: 'Vancouver', lat: 49.1947, lon: -123.1763 }, { id: 'YUL', name: 'Montréal Trudeau', lat: 45.4657, lon: -73.7455 },
            { id: 'HNL', name: 'Honolulu', lat: 21.3187, lon: -157.9225 }, { id: 'MEX', name: 'Città del Messico', lat: 19.4361, lon: -99.0719 },
            { id: 'IAD', name: 'Washington Dulles', lat: 38.9445, lon: -77.4558 }, { id: 'PHX', name: 'Phoenix Sky Harbor', lat: 33.4352, lon: -112.0101 },
            { id: 'ANC', name: 'Anchorage', lat: 61.1743, lon: -149.9962 }, { id: 'GRU', name: 'San Paolo Guarulhos', lat: -23.4356, lon: -46.4731 },
            { id: 'GIG', name: 'Rio de Janeiro Galeão', lat: -22.8089, lon: -43.2436 }, { id: 'EZE', name: 'Buenos Aires Ezeiza', lat: -34.8150, lon: -58.5348 },
            { id: 'SCL', name: 'Santiago del Cile', lat: -33.3930, lon: -70.7858 }, { id: 'BOG', name: 'Bogotà El Dorado', lat: 4.7016, lon: -74.1469 },
            { id: 'LIM', name: 'Lima Jorge Chávez', lat: -12.0240, lon: -77.1143 }, { id: 'PTY', name: 'Panama City Tocumen', lat: 9.0714, lon: -79.3835 },
            { id: 'CUN', name: 'Cancún', lat: 21.0365, lon: -86.8771 }, { id: 'SJO', name: 'San José (Costa Rica)', lat: 9.9939, lon: -84.2088 },
            { id: 'UIO', name: 'Quito', lat: -0.1292, lon: -78.3575 }, { id: 'MVD', name: 'Montevideo', lat: -34.8384, lon: -56.0308 },
            { id: 'HND', name: 'Tokyo Haneda', lat: 35.5494, lon: 139.7798 }, { id: 'NRT', name: 'Tokyo Narita', lat: 35.7720, lon: 140.3929 },
            { id: 'KIX', name: 'Osaka Kansai', lat: 34.4320, lon: 135.2304 }, { id: 'ICN', name: 'Seoul Incheon', lat: 37.4602, lon: 126.4407 },
            { id: 'PEK', name: 'Pechino Capital', lat: 40.0799, lon: 116.6031 }, { id: 'PKX', name: 'Pechino Daxing', lat: 39.5098, lon: 116.4105 },
            { id: 'PVG', name: 'Shanghai Pudong', lat: 31.1443, lon: 121.8083 }, { id: 'HKG', name: 'Hong Kong', lat: 22.3080, lon: 113.9185 },
            { id: 'TPE', name: 'Taipei Taoyuan', lat: 25.0797, lon: 121.2342 }, { id: 'SIN', name: 'Singapore Changi', lat: 1.3644, lon: 103.9915 },
            { id: 'BKK', name: 'Bangkok Suvarnabhumi', lat: 13.6900, lon: 100.7501 }, { id: 'KUL', name: 'Kuala Lumpur', lat: 2.7456, lon: 101.7099 },
            { id: 'MNL', name: 'Manila', lat: 14.5086, lon: 121.0194 }, { id: 'SGN', name: 'Ho Chi Minh Tan Son Nhat', lat: 10.8188, lon: 106.6519 },
            { id: 'CGK', name: 'Jakarta Soekarno-Hatta', lat: -6.1256, lon: 106.6559 }, { id: 'DEL', name: 'Nuova Delhi Indira Gandhi', lat: 28.5562, lon: 77.1000 },
            { id: 'BOM', name: 'Mumbai Chhatrapati Shivaji', lat: 19.0896, lon: 72.8656 }, { id: 'DXB', name: 'Dubai International', lat: 25.2532, lon: 55.3657 },
            { id: 'DOH', name: 'Doha Hamad', lat: 25.2731, lon: 51.6080 }, { id: 'AUH', name: 'Abu Dhabi', lat: 24.4330, lon: 54.6511 },
            { id: 'TLV', name: 'Tel Aviv Ben Gurion', lat: 32.0055, lon: 34.8854 }, { id: 'DPS', name: 'Bali Denpasar', lat: -8.7482, lon: 115.1672 },
            { id: 'MLE', name: 'Malé (Maldive)', lat: 4.1918, lon: 73.5291 }, { id: 'HAN', name: 'Hanoi Noi Bai', lat: 21.2212, lon: 105.8072 },
            { id: 'CMB', name: 'Colombo Bandaranaike', lat: 7.1808, lon: 79.8841 }, { id: 'CAI', name: 'Il Cairo', lat: 30.1219, lon: 31.4056 },
            { id: 'JNB', name: 'Johannesburg O.R. Tambo', lat: -26.1367, lon: 28.2411 }, { id: 'CPT', name: 'Città del Capo', lat: -33.9715, lon: 18.6021 },
            { id: 'LOS', name: 'Lagos Murtala Muhammed', lat: 6.5774, lon: 3.3215 }, { id: 'NBO', name: 'Nairobi Jomo Kenyatta', lat: -1.3192, lon: 36.9275 },
            { id: 'ADD', name: 'Addis Ababa Bole', lat: 8.9778, lon: 38.7993 }, { id: 'CMN', name: 'Casablanca Mohammed V', lat: 33.3675, lon: -7.5899 },
            { id: 'RAK', name: 'Marrakech Menara', lat: 31.6069, lon: -8.0363 }, { id: 'TUN', name: 'Tunisi Cartagine', lat: 36.8510, lon: 10.2272 },
            { id: 'SEZ', name: 'Seychelles', lat: -4.6743, lon: 55.5219 }, { id: 'MRU', name: 'Mauritius', lat: -20.4302, lon: 57.6836 },
            { id: 'SYD', name: 'Sydney Kingsford Smith', lat: -33.9399, lon: 151.1753 }, { id: 'MEL', name: 'Melbourne', lat: -37.6690, lon: 144.8410 },
            { id: 'BNE', name: 'Brisbane', lat: -27.3842, lon: 153.1175 }, { id: 'PER', name: 'Perth', lat: -31.9385, lon: 115.9672 },
            { id: 'AKL', name: 'Auckland', lat: -37.0082, lon: 174.7850 }, { id: 'CHC', name: 'Christchurch', lat: -43.4876, lon: 172.5369 },
            { id: 'NAN', name: 'Nadi (Fiji)', lat: -17.7554, lon: 177.4433 }, { id: 'PPT', name: 'Papeete (Tahiti)', lat: -17.5567, lon: -149.6108 },

            // --- NUOVI 30 AEROPORTI AGGIUNTI (Europa Est, Africa, Asia, Oceania) ---
            { id: 'LYS', name: 'Lione Saint-Exupéry', lat: 45.7256, lon: 5.0811 },
            { id: 'MRS', name: 'Marsiglia Provenza', lat: 43.4367, lon: 5.2150 },
            { id: 'MAN', name: 'Manchester', lat: 53.3656, lon: -2.2734 },
            { id: 'BHX', name: 'Birmingham', lat: 52.4539, lon: -1.7480 },
            { id: 'GLA', name: 'Glasgow', lat: 55.8719, lon: -4.4331 },
            { id: 'HAM', name: 'Amburgo', lat: 53.6304, lon: 9.9882 },
            { id: 'DUS', name: 'Düsseldorf', lat: 51.2895, lon: 6.7668 },
            { id: 'STR', name: 'Stoccarda', lat: 48.6899, lon: 9.2220 },
            { id: 'BEG', name: 'Belgrado Nikola Tesla', lat: 44.8184, lon: 20.3091 },
            { id: 'SOF', name: 'Sofia', lat: 42.6967, lon: 23.4114 },
            { id: 'OTP', name: 'Bucarest Otopeni', lat: 44.5722, lon: 26.1022 },
            { id: 'ZAG', name: 'Zagabria Franjo Tuđman', lat: 45.7429, lon: 16.0688 },
            { id: 'LJU', name: 'Lubiana Jože Pučnik', lat: 46.2237, lon: 14.4576 },
            { id: 'TIA', name: 'Tirana', lat: 41.4147, lon: 19.7206 },
            { id: 'KRK', name: 'Cracovia Giovanni Paolo II', lat: 50.0777, lon: 19.7848 },
            { id: 'OPO', name: 'Porto Francisco Sá Carneiro', lat: 41.2481, lon: -8.6814 },
            { id: 'AGP', name: 'Malaga Costa del Sol', lat: 36.6749, lon: -4.4991 },
            { id: 'KTM', name: 'Kathmandu Tribhuvan', lat: 27.6966, lon: 85.3591 },
            { id: 'DAC', name: 'Dacca Shahjalal', lat: 23.8433, lon: 90.3978 },
            { id: 'RGN', name: 'Yangon', lat: 16.9073, lon: 96.1332 },
            { id: 'CTS', name: 'Sapporo New Chitose', lat: 42.7752, lon: 141.6923 },
            { id: 'FUK', name: 'Fukuoka', lat: 33.5859, lon: 130.4506 },
            { id: 'ADL', name: 'Adelaide', lat: -34.9450, lon: 138.5306 },
            { id: 'DRW', name: 'Darwin', lat: -12.4147, lon: 130.8767 },
            { id: 'WLG', name: 'Wellington', lat: -41.3276, lon: 174.8076 },
            { id: 'ZQN', name: 'Queenstown', lat: -45.0213, lon: 168.7390 },
            { id: 'TBU', name: 'Nuku\'alofa Fua\'amotu', lat: -21.2413, lon: -175.1401 },
            { id: 'ACC', name: 'Accra Kotoka', lat: 5.6052, lon: -0.1668 },
            { id: 'KGL', name: 'Kigali', lat: -1.9686, lon: 30.1395 },
            { id: 'TNR', name: 'Antananarivo Ivato', lat: -18.7969, lon: 47.4788 }
        ];
        airports.sort((a, b) => a.name.localeCompare(b.name));

        const map = L.map('map', {
            center: [30, 10], zoom: 3, minZoom: 2,
            zoomControl: false, attributionControl: false, 
            worldCopyJump: false, maxBounds: [[-85, -Infinity], [85, Infinity]], maxBoundsViscosity: 1.0,
            zoomSnap: 0.1, // Rende lo zoom fluido e permette decimali
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 100 // Rende lo scroll del mouse più morbido
        });

        // --- NEW MAP LAYERS LOGIC ---
        // Changed to Esri Satellite (from flight.html)
        const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 });
        
        const osmLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 20
        });

        // Init Default: Satellite
        let currentMapMode = 'sat'; // 'sat' or 'osm'
        satLayer.addTo(map);
        labelsLayer.addTo(map);

        L.control.zoom({ position: 'bottomright' }).addTo(map);
        setTimeout(() => { map.invalidateSize(); }, 100);

        const airportDotStyle = {
            radius: 4, fillColor: "rgba(248, 250, 252, 0.7)", color: "rgba(56, 189, 248, 0.8)", weight: 1.5, opacity: 1, fillOpacity: 0.7
        };
        airports.forEach(ap => {
            L.circleMarker([ap.lat, ap.lon], airportDotStyle).addTo(map).bindTooltip(ap.name);
        });

        let flightSpeedMultiplier = 1;
        function setSpeed(mult) {
            flightSpeedMultiplier = mult;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        const depSelect = document.getElementById('departure');
        const arrSelect = document.getElementById('arrival');
        airports.forEach(ap => {
            const label = `${ap.name} (${ap.id})`;
            depSelect.add(new Option(label, ap.id)); arrSelect.add(new Option(label, ap.id));
        });
        depSelect.value = 'FCO'; arrSelect.value = 'JFK';

        function randomizeRoute() {
            let depIndex = Math.floor(Math.random() * airports.length);
            let arrIndex;
            do { arrIndex = Math.floor(Math.random() * airports.length); } while (depIndex === arrIndex);
            depSelect.value = airports[depIndex].id; arrSelect.value = airports[arrIndex].id;
        }

        function toggleTelemetry() { document.getElementById('telemetry-dropdown').classList.toggle('open'); }
        let isFollowingPlane = false;
        function toggleFollowPlane() {
            const t = translations[currentLang];
            isFollowingPlane = !isFollowingPlane;
            const btn = document.getElementById('follow-btn');
            btn.classList.toggle('active', isFollowingPlane);
            document.getElementById('follow-text').innerText = isFollowingPlane ? t.stop_follow : t.follow_plane;
            if(isFollowingPlane && planeMarker) { 
                map.flyTo(planeMarker.getLatLng(), 90, { duration: 1.5, easeLinearity: 0.5 }); 
            }
        }

        let planeMarker = null, routeLine = null, flightInterval = null;
        let isLanding = false, landingZoomInterval = null, landingZoomLevel = 12;
        let departureMarker = null, arrivalMarker = null;

        // --- NEW: TRAVELED LINE VARIABLE ---
        let traveledLine = null;

        // --- NEW VARIABLES FOR PAUSE & MAP ---
        let isPaused = false;

        function togglePause() {
            if (!flightInterval) return;
            const t = translations[currentLang];
            isPaused = !isPaused;
            
            const btn = document.getElementById('pause-btn');
            const span = btn.querySelector('span');
            const icon = btn.querySelector('i');
            
            if (isPaused) {
                btn.classList.add('paused');
                span.innerText = t.resume;
                icon.className = 'fa-solid fa-play';
            } else {
                btn.classList.remove('paused');
                span.innerText = t.pause;
                icon.className = 'fa-solid fa-pause';
            }
        }

        function toggleMapType() {
            const t = translations[currentLang];
            const btn = document.getElementById('map-btn');
            const span = btn.querySelector('span');
            const icon = btn.querySelector('i');

            if (currentMapMode === 'sat') {
                map.removeLayer(satLayer);
                map.removeLayer(labelsLayer);
                osmLayer.addTo(map);
                currentMapMode = 'osm';
                span.innerText = t.sat_view;
                icon.className = 'fa-solid fa-satellite';
            } else {
                map.removeLayer(osmLayer);
                satLayer.addTo(map);
                labelsLayer.addTo(map);
                currentMapMode = 'sat';
                span.innerText = t.map_view;
                icon.className = 'fa-solid fa-map';
            }
        }

        const createPlaneIcon = (rotation) => L.divIcon({
            className: 'plane-icon-wrapper',
            html: `<i class="fa-solid fa-plane" style="display:block; font-size: 32px; color: var(--primary); transform: rotate(${rotation - 90}deg); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.8)); text-shadow: 0 0 10px var(--primary);"></i>`,
            iconSize: [32, 32], iconAnchor: [16, 16]
        });
        const createAirportMarker = (color) => L.divIcon({
            className: 'airport-dot',
            html: `<div style="width:14px; height:14px; background:${color}; border-radius:50%; border:2px solid white; box-shadow:0 0 10px ${color};"></div><div class="pulse-ring" style="border-color:${color}"></div>`,
            iconSize: [14, 14], iconAnchor: [7, 7]
        });

        function updateDayNightCycle(hour) {
            const overlay = document.getElementById('day-night-overlay');
            if (hour >= 20 || hour < 6) overlay.style.opacity = 1;
            else if (hour >= 6 && hour < 8) overlay.style.opacity = 0.3;
            else if (hour >= 18 && hour < 20) overlay.style.opacity = 0.5;
            else overlay.style.opacity = 0;
        }
        function formatTime(seconds) {
            if(seconds < 60) return `${Math.floor(seconds)}s`;
            const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60);
            return `${m}m ${s}s`;
        }
        function getPointOnLine(startLat, startLon, endLat, endLon, t) {
            const lat = startLat + (endLat - startLat) * t;
            const lon = startLon + (endLon - startLon) * t;
            return [lat, lon];
        }

        const airlineCodes = {
            'RYR': 'FR', 'EZY': 'U2', 'ITY': 'AZ', 'DLH': 'LH', 'AFR': 'AF',
            'BAW': 'BA', 'UAE': 'EK', 'AAL': 'AA', 'DAL': 'DL', 'WZZ': 'W6'
        };

        function startFlight() {
            const t = translations[currentLang];
            if(planeMarker) map.removeLayer(planeMarker);
            if(routeLine) map.removeLayer(routeLine);
            if(traveledLine) map.removeLayer(traveledLine); // Remove old traveled line
            if(departureMarker) map.removeLayer(departureMarker);
            if(arrivalMarker) map.removeLayer(arrivalMarker);
            
            if(flightInterval) clearInterval(flightInterval);
            isLanding = false; isFollowingPlane = false; isPaused = false;
            
            const pauseBtn = document.getElementById('pause-btn');
            pauseBtn.classList.remove('paused');
            pauseBtn.querySelector('span').innerText = t.pause;
            pauseBtn.querySelector('i').className = 'fa-solid fa-pause';

            const dep = airports.find(a => a.id === depSelect.value);
            const arr = airports.find(a => a.id === arrSelect.value);
            const aircraftType = document.getElementById('aircraft-type').value;
            const airlineType = document.getElementById('airline-select').value;

            if(dep.id === arr.id) return;

            document.getElementById('fly-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'flex';
            
            let baseSpeed = 480, cruiseAltitude = 36000, passengers = 0;
            if (aircraftType === 'B787') { baseSpeed = 500; cruiseAltitude = 39000; passengers = Math.floor(Math.random() * (296 - 150) + 150); }
            else if (aircraftType === 'C172') { baseSpeed = 120; cruiseAltitude = 8000; passengers = Math.floor(Math.random() * (3 - 1) + 1); }
            else if (aircraftType === 'CONC') { baseSpeed = 1100; cruiseAltitude = 55000; passengers = Math.floor(Math.random() * (100 - 40) + 40); }
            else if (aircraftType === 'B747') { baseSpeed = 510; cruiseAltitude = 38000; passengers = Math.floor(Math.random() * (410 - 250) + 250); }
            else if (aircraftType === 'A380') { baseSpeed = 505; cruiseAltitude = 39000; passengers = Math.floor(Math.random() * (550 - 300) + 300); }
            else if (aircraftType === 'B737') { baseSpeed = 450; cruiseAltitude = 35000; passengers = Math.floor(Math.random() * (189 - 100) + 100); }
            else if (aircraftType === 'A350') { baseSpeed = 500; cruiseAltitude = 40000; passengers = Math.floor(Math.random() * (350 - 200) + 200); }
            else if (aircraftType === 'E190') { baseSpeed = 440; cruiseAltitude = 33000; passengers = Math.floor(Math.random() * (100 - 50) + 50); }
            else if (aircraftType === 'G7500') { baseSpeed = 510; cruiseAltitude = 45000; passengers = Math.floor(Math.random() * (15 - 1) + 1); }
            else if (aircraftType === 'F22') { baseSpeed = 1200; cruiseAltitude = 60000; passengers = 1; }
            else if (aircraftType === 'AN225') { baseSpeed = 430; cruiseAltitude = 30000; passengers = 6; }
            else if (aircraftType === 'SPIT') { baseSpeed = 300; cruiseAltitude = 20000; passengers = 1; }
            else if (aircraftType === 'PC12') { baseSpeed = 270; cruiseAltitude = 25000; passengers = 8; }
            else { passengers = Math.floor(Math.random() * (180 - 80) + 80); }

            const prefix = airlineCodes[airlineType] || 'FL';
            const flightNo = (prefix + ' ' + Math.floor(Math.random() * 9000 + 100));
            
            const weatherConditions = ['Sereno ☀️', 'Nuvoloso ⛅', 'Pioggia 🌧️', 'Vento 💨', 'Temporale ⛈️'];
            const weatherDest = weatherConditions[Math.floor(Math.random() * weatherConditions.length)];

            document.getElementById('flight-no').innerText = `Volo: ${flightNo} | ${aircraftType}`;
            document.getElementById('pax-count').innerHTML = `<i class="fa-solid fa-users" style="color:var(--primary)"></i> ${passengers}`;
            document.getElementById('top-weather-dest').innerHTML = weatherDest;
            document.getElementById('telemetry-cabin').style.display = 'block'; 
            document.getElementById('telemetry-dropdown').classList.add('open');
            document.getElementById('eta-display').style.display = 'flex';
            document.getElementById('center-controls').style.display = 'flex';
            
            const followBtn = document.getElementById('follow-btn');
            followBtn.classList.remove('active');
            document.getElementById('follow-text').innerText = t.follow_plane;

            let destLon = arr.lon;
            const diff = destLon - dep.lon;
            if (diff > 180) destLon -= 360; else if (diff < -180) destLon += 360;

            const linePoints = []; const steps = 100;
            for (let i = 0; i <= steps; i++) linePoints.push(getPointOnLine(dep.lat, dep.lon, arr.lat, destLon, i / steps));

            routeLine = L.polyline(linePoints, { color: '#38bdf8', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
            
            // --- NEW: INITIALIZE TRAVELED LINE (STYLE CORRETTO) ---
            // Stile tratteggiato identico a routeLine, ma verde
            traveledLine = L.polyline([[dep.lat, dep.lon]], { color: '#10b981', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map);

            map.fitBounds(routeLine.getBounds(), { padding: [80, 80] });

            departureMarker = L.marker([dep.lat, dep.lon], {icon: createAirportMarker('#10b981')}).addTo(map);
            arrivalMarker = L.marker([arr.lat, arr.lon], {icon: createAirportMarker('#ef4444')}).addTo(map);

            let progress = 0;
            const distanceKM = map.distance([dep.lat, dep.lon], [arr.lat, arr.lon]) / 1000;
            const distanceNM = distanceKM * 0.539957;
            const totalSteps = Math.max(5000, distanceNM * 15); 
            let currentFuel = 100;

            let curLat = dep.lat; let curLon = dep.lon;
            const dLatInit = arr.lat - dep.lat;
            const dLonInit = destLon - dep.lon;
            const initialBearing = (Math.atan2(dLonInit, dLatInit) * 180 / Math.PI + 360) % 360;

            planeMarker = L.marker([dep.lat, dep.lon], { icon: createPlaneIcon(initialBearing), zIndexOffset: 10000 }).addTo(map);

            flightInterval = setInterval(() => {
                if (isPaused) return;

                progress += (1 * flightSpeedMultiplier);
                let pct = Math.min(progress / totalSteps, 1);
                
                if (pct > 0.9 && pct < 1) {
                    isLanding = true;
                    const landingPct = (pct - 0.9) / 0.1; 
                    const decelerationFactor = 1 - (landingPct * 0.7); 
                    progress += (1 * flightSpeedMultiplier * decelerationFactor);
                    pct = Math.min(progress / totalSteps, 1);
                    
                    // FIX: Zoom e pan automatico SOLO se l'utente sta seguendo l'aereo
                    if (isFollowingPlane && map.getZoom() < landingZoomLevel) {
                         const currentZoom = map.getZoom();
                         const targetZoom = Math.min(landingZoomLevel, currentZoom + 0.05); 
                         map.setZoom(targetZoom); 
                         map.panTo(planeMarker.getLatLng());
                    }
                } else if (pct >= 1) { endFlight(); return; }

                const prevLat = curLat; const prevLon = curLon;
                const pos = getPointOnLine(dep.lat, dep.lon, arr.lat, destLon, pct);
                curLat = pos[0]; curLon = pos[1];
                
                planeMarker.setLatLng([curLat, curLon]);
                
                // --- NEW: DYNAMIC UPDATE WITHOUT OVERLAP ---
                // Calcoliamo l'indice del segmento corrente basato sulla percentuale
                const currentStepIndex = Math.min(Math.floor(pct * steps), steps - 1);
                
                // 1. Linea percorsa (Verde Tratteggiata): Dall'inizio fino al punto corrente
                const traveledPath = linePoints.slice(0, currentStepIndex + 1);
                traveledPath.push([curLat, curLon]);
                traveledLine.setLatLngs(traveledPath);

                // 2. Linea rimanente (Blu Tratteggiata): Dal punto corrente fino alla fine
                const remainingPath = [[curLat, curLon], ...linePoints.slice(currentStepIndex + 1)];
                routeLine.setLatLngs(remainingPath);

                const dLat = arr.lat - curLat;
                const dLon = destLon - curLon;
                const realTimeBearing = (Math.atan2(dLon, dLat) * 180 / Math.PI + 360) % 360;
                
                planeMarker.setIcon(createPlaneIcon(realTimeBearing));

                if (isFollowingPlane) map.panTo(planeMarker.getLatLng());

                const offset = Math.round(curLon / 15);
                const utc = new Date();
                const localHour = (utc.getUTCHours() + offset + 24) % 24;
                const localMin = utc.getUTCMinutes().toString().padStart(2, '0');
                document.getElementById('top-local-time').innerText = `${localHour}:${localMin}`; 
                
                updateDayNightCycle(localHour);
                updateTelemetry(pct, cruiseAltitude, baseSpeed, distanceNM, currentFuel);
                
                const stepsRemaining = totalSteps - progress;
                const msRemaining = (stepsRemaining * 20) / flightSpeedMultiplier;
                if(msRemaining > 0) document.getElementById('eta-text').innerText = t.eta_prefix + formatTime(msRemaining / 1000);
                else document.getElementById('eta-text').innerText = isLanding ? t.eta_landing_now : t.eta_landing_soon;

                currentFuel = Math.max(0, 100 - (pct * 95));
            }, 20); 
        }

        function cancelFlight() {
            const t = translations[currentLang];
            if(flightInterval) clearInterval(flightInterval);
            isPaused = false;
            
            if(planeMarker) map.removeLayer(planeMarker);
            if(routeLine) map.removeLayer(routeLine);
            if(traveledLine) map.removeLayer(traveledLine); // Remove green line
            if(departureMarker) { map.removeLayer(departureMarker); departureMarker = null; }
            if(arrivalMarker) { map.removeLayer(arrivalMarker); arrivalMarker = null; }
            
            document.getElementById('eta-display').style.display = 'none';
            document.getElementById('center-controls').style.display = 'none';
            document.getElementById('telemetry-dropdown').classList.remove('open');
            document.getElementById('telemetry-cabin').style.display = 'none';
            document.getElementById('day-night-overlay').style.opacity = 0;
            
            const flyBtn = document.getElementById('fly-btn');
            flyBtn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> <span id="fly-btn-text">${t.takeoff}</span>`;
            flyBtn.disabled = false; flyBtn.style.display = 'flex';
            document.getElementById('cancel-btn').style.display = 'none';

            document.getElementById('status-val').innerText = t.status_cancelled;
            document.getElementById('status-val').style.color = "#ef4444";
            document.getElementById('spd-val-top').innerText = "0";
            document.getElementById('dist-val-top').innerText = "0";
            document.getElementById('pax-count').innerHTML = `<i class="fa-solid fa-users" style="color:var(--primary)"></i> --`;
            
            map.flyTo([30, 10], 3, { duration: 1.5, easeLinearity: 0.5 }); 
        }

        function updateTelemetry(pct, maxAlt, maxSpd, totalDist, fuel) {
            const t = translations[currentLang];
            let currentAlt, currentSpd, status, statusColor;
            
            if(pct < 0.1) {
                status = t.status_takeoff; statusColor = "#fbbf24";
                currentAlt = maxAlt * (pct / 0.1); currentSpd = maxSpd * (pct / 0.1);
            } else if (pct > 0.9 && pct < 1) {
                status = t.status_landing; statusColor = "#fbbf24";
                const landingFactor = (1 - ((pct - 0.9) / 0.1)); 
                currentAlt = maxAlt * landingFactor;
                currentSpd = maxSpd * (0.3 + (landingFactor * 0.7)); 
            } else {
                status = t.status_cruise; statusColor = "#38bdf8";
                currentAlt = maxAlt; currentSpd = maxSpd; 
                if(pct > 0.2 && pct < 0.22) status = t.status_meal;
                if(pct > 0.5 && pct < 0.52) status = t.status_systems;
            }

            document.getElementById('alt-val-top').innerText = Math.floor(Math.max(0, currentAlt)).toLocaleString();
            document.getElementById('spd-val-top').innerText = Math.floor(Math.max(0, currentSpd));
            document.getElementById('dist-val-top').innerText = Math.floor(totalDist * (1 - pct));
            document.getElementById('fuel-val-top').innerText = Math.floor(fuel);

            document.getElementById('status-val').innerText = status;
            document.getElementById('status-val').style.color = statusColor;
            
            const fuelContainer = document.getElementById('fuel-val-top-container');
            if(fuel < 20) fuelContainer.style.color = "#ef4444"; else fuelContainer.style.color = "#10b981";
        }

        function endFlight() {
            const t = translations[currentLang];
            clearInterval(flightInterval);
            isPaused = false;
            if(departureMarker) { map.removeLayer(departureMarker); departureMarker = null; }
            if(arrivalMarker) { map.removeLayer(arrivalMarker); arrivalMarker = null; }

            document.getElementById('status-val').innerText = t.status_arrived;
            document.getElementById('status-val').style.color = "#10b981";
            document.getElementById('spd-val-top').innerText = "0";
            document.getElementById('dist-val-top').innerText = "0";
            
            const flyBtn = document.getElementById('fly-btn');
            flyBtn.innerHTML = `<i class="fa-solid fa-check"></i> <span id="fly-btn-text">${t.completed}</span>`;
            flyBtn.disabled = false; flyBtn.style.display = 'flex';
            document.getElementById('cancel-btn').style.display = 'none';
            
            document.getElementById('eta-display').style.display = 'none';
            document.getElementById('center-controls').style.display = 'none';
            document.getElementById('day-night-overlay').style.opacity = 0;

            isFollowingPlane = false;
            const followBtn = document.getElementById('follow-btn');
            followBtn.classList.remove('active');
            document.getElementById('follow-text').innerText = t.follow_plane;

            setTimeout(() => { 
                document.getElementById('telemetry-dropdown').classList.remove('open'); 
                document.getElementById('telemetry-cabin').style.display = 'none'; 
                if(traveledLine) map.removeLayer(traveledLine); // Clean up green line after delay
                if(routeLine) map.removeLayer(routeLine);
            }, 3000);
            
            setTimeout(() => { map.flyTo([map.getCenter().lat, map.getCenter().lng], 5, { duration: 1.5, easeLinearity: 0.5 }); }, 2000);
            setTimeout(() => { flyBtn.innerHTML = `<i class="fa-solid fa-paper-plane"></i> <span id="fly-btn-text">${t.takeoff}</span>`; }, 4000);
        }

        // Funzione helper ortodromica
        function calculateBearing(startLat, startLng, destLat, destLng) {
            const y = Math.sin(toRadians(destLng - startLng)) * Math.cos(toRadians(destLat));
            const x = Math.cos(toRadians(startLat)) * Math.sin(toRadians(destLat)) -
                      Math.sin(toRadians(startLat)) * Math.cos(toRadians(destLat)) * Math.cos(toRadians(destLng - startLng));
            const brng = Math.atan2(y, x);
            return (toDegrees(brng) + 360) % 360;
        }
        function toRadians(deg) { return deg * (Math.PI/180); }
        function toDegrees(rad) { return rad * (180/Math.PI); }

        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 'f') toggleFollowPlane();
            if(e.key.toLowerCase() === 'p') togglePause();
        });
    </script>
</body>
</html>
